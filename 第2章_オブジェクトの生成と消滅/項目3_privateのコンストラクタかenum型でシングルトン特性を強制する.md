# 第2章 オブジェクトの生成と消滅

## 項目3　privateのコンストラクタかenum型でシングルトン特性を強制する

**シングルトン** ・・・一度しかインスタンスが生成されないクラス

---

クラスをシングルトンにすることは、それを使用するクラスをテストするのを**困難**にする。

### なぜ困難にするのか

シングルトンがインターフェースを実装していない限り、モックで置き換えることは不可能であるから。

---

通常、シングルトンクラスを作成する場合にはコンストラクタをprivateにして、自身のインスタンスを`final static`として保持しておくのが一般的。

```java
public class Item {
    public static final Item INSTANCE = new Item();
    private Item(){
        // 
    }
}
```

`public`あるいは`protected`なコンストラクタが存在していないことで、`Item`のインスタンスが１度だけしか生成されないことを**保証**します。<br/>
ただし、注意点としてリフレクションを用いれば`private`なコンストラクタを呼び出すことができるので、これを防御したい場合には、２個目のインスタンスが生成されようとした場合に例外をスローさせるようにする。

また、別のシングルトン実装は、staticファクトリメソッドを使用する場合。

```java
public class Item {
    private static final Item INSTANCE = new Item();
    private Item(){
        // 
    }
    
    public static Item getInstance(){
        return INSTANCE;
    }
}
```

staticファクトリメソッドの場合でも、リフレクションの注意点は変わりません。

publicなフィールドへの参照の長所としては、シングルトンであることが明白である点。<br/>
`public static final`なので、同一インスタンスにアクセスしていることは自明。<br/>
だが、publicフィールドにすることでのパフォーマンス上の利点は皆無。<br/>
→何故かというと、最新のJVM実装ではstaticファクトリメソッドに対する呼び出しを、ほぼ確実にインライン化するため。

ファクトリメソッドによる利点としては、**APIを変更することなく、シングルトンであるべきかどうかを変更できる柔軟性がある**点。

特に要件がない場合には、publiフィールドへの参照が単純。

---

### シングルトンクラスのシリアライズ化

シングルトンなクラスをシリアライズする場合、単に`implements Serializable`を追加するだけでは不十分。

シングルトンであることを保証する場合、すべてのインスタンスフィールドには`transient`修飾を行い、`readResolve`メソッドを提供しなければならない。

そうでなければ、シリアライズされたインスタンスをデシリアライズする際に、新たなインスタンスが生成されてしまう。<br/>
シリアライズされる前のインスタンスと、デシリアライズされたインスタンスは異なるため、シングルトンではなくなってしまう。

これを防ぐには、シングルトンクラスに以下のメソッドを追加する。

```java
// シングルトン特性を保持するための、readResolveメソッド
private Object readResolve() throws ObjectStreamException {
    return INSTANCE;
}
```

---

### シングルトンを実装する最善の方法

シングルトンを実装する最善の方法は、**単一要素を持つenumを定義する**だけ。

```java
public enum Item {
    INSTANCE;
}
```

この方法は、機能的にはpubliフィールドによる方法と一緒だが、簡潔でシリアライズの機能を提供している。<br/>
また、シリアライズやリフレクションを用いた攻撃を受けても、複数インスタンスの生成を阻止する鉄壁な保証を提供している。

## まとめ

* シングルトンクラスをMock化したい場合には、インターフェースを実装させましょう。
* シングルトン実装には、publicフィールドにするパターン、ファクトリメソッドを使用するパターン、単一要素を持つenumを定義するパターンの合計３パターンある。
* enum以外のシングルトン実装を行う場合には、リフレクションとシリアライズには注意しましょう。

