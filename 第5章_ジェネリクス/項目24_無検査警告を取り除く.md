# 項目24 無検査警告を取り除く

## 無検査警告

ジェネリックスを利用したプログラムでは、コンパイラが多くの無検査警告を出す。

* 無検査キャスト警告
* 無検査メソッド呼び出し警告
* 無検査ジェネリック配列生成警告
* 無検査変換警告

例えば以下のコードは無検査変換警告が出る。

```java
List<String> list = new ArrayList();

// NoCheckedWarning.java:10: 警告: [unchecked] 無検査変換
// List<String> list = new ArrayList();
//                            ^
// 期待値: List<String>
// 検出値:    ArrayList
// 警告1個
```

この警告を取り除くには、以下のように変更する。

```java
List<String> list = new ArrayList<>();
```

多くの無検査警告を取り除くのは簡単。  
**取り除くことが可能な無検査警告は、すべて取り除くこと**。

そうすることで、コードが型安全であると安心でき、実行時に `ClassCastException` がスローされないことも保証される。  


## `@SuppressWarnings` で警告を抑制する

警告によっては、無検査警告を取り除くことが難しい場合もある。  
その場合、**警告を起こしているコードが型安全であると明確に示すことが出来れば、その時（そして、その時に限り）`@SuppressWarnings("unchecked")` アノテーションで警告を抑制する** 。

その理由としては

* 「とりあえず抑制」すると、誤った安心感を持ってしまう。
  * 「コンパイラの警告が消えた」という安心感。
* 実行時に `ClassCastException` がスローされてしまう可能性がある。
* 型安全であると分かっているのに警告を無視（抑制しない）したら、本当の問題を示す警告に気づくことが出来ない。
  * 新しい（本当に問題のある）警告が、抑制しなかった見せかけの警告に埋もれてしまう。

がある。


## `@SuppressWarnings` アノテーションは最小のスコープで使用する

`@SuppressWarnings` アノテーションは、クラス全体〜ローカル変数に至るまで、どこでも使用できる。  
しかし、**出来る限り最小のスコープに対して使用すること** 。

`ArrayList` の `toArray` メソッドを例に挙げてみる。

```java
public <T> T[] toArray(T[] a){

    if(a.length < size){
        return (T[])Arrays.copyOf(elements, size, a.getClass());  // ここで無検査キャスト警告
    }

    System.arraycopy(elements, 0, a, 0, size);

    if(a.length > size) a[size] = null;
    return a;
}
```

上記のコードは、4行目の配列を生成する処理で無検査キャスト警告が出る。  
この時、**メソッド全体に対してアノテーションを付けてはいけない** 。  
なぜなら、他の重大な警告まで抑制されてしまう可能性があるため。


代わりに、戻り値を保持するローカル変数を定義し、その変数に対してアノテーションを注釈する。
そうすることでこのメソッドは警告無くコンパイルされ、無検査警告が抑制されるスコープを最小限にすることができる。

```java
public <T> T[] toArray(T[] a){

    if(a.length < size){
        // T[] として渡された引数と同じ型の配列を生成するので、このキャストは正しい。
        @SuppessWarnings("unchecked")
        T[] result = (T[])Arrays.copyOf(elements, size, a.getClass());
        return result;
    }

    System.arraycopy(elements, 0, a, 0, size);

    if(a.length > size) a[size] = null;
    return a;
}
```

また、 `SuppressWarnings` アノテーションを注釈する場合には、
**そうする（抑制する）のが安全である理由を述べるコメントを必ず追加する** こと。  
コメントを記載しなければ、他の人が型安全でなくなるような変更を行ってしまうかもしれない。


## まとめ


* 無検査警告は重要であるため、無視はしないこと。
  * 全ての無検査警告は、実行時に `ClassCastException` がスローされる可能性を表している。
* 無視はしないが、無検査警告は全て取り除く（抑制する）こと。
* 無検査警告が取り除けない場合、最小のスコープで `@SuppressWarnings` による警告の抑制を行う。
  * ただし、その警告を出しているコードが型安全であると明確に示すことが出来る場合に限る。
  * また、抑制する場合には「なぜ抑制したか」の理由をコメントとして記載すること。